<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FindThisThread Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-card: #242424;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --accent: #ff4500;
      --accent-dim: #cc3700;
      --success: #46d160;
      --warning: #f0b429;
      --error: #e53935;
      --border: #333;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .stats-row {
      display: flex;
      gap: 12px;
    }

    .stat-badge {
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .stat-badge .value {
      font-weight: 600;
      color: var(--accent);
    }

    /* Timer Section */
    .timer-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .timer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .timer-header h2 {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .timer-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .refresh-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .refresh-btn.loading {
      color: transparent;
      position: relative;
    }

    .refresh-btn.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid var(--border);
      border-top-color: var(--text-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .timer-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .timer-bar-container {
      background: var(--bg-card);
      border-radius: 8px;
      height: 12px;
      overflow: hidden;
    }

    .timer-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-dim));
      border-radius: 8px;
      transition: width 0.5s ease;
    }

    .timer-text {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .timer-countdown {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Sections */
    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .section-count {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Mention Cards */
    .mentions-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mention-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      transition: border-color 0.2s;
    }

    .mention-card:hover {
      border-color: var(--accent);
    }

    .mention-header {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 12px;
    }

    .mention-result {
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .result-found {
      background: rgba(70, 209, 96, 0.15);
      color: var(--success);
    }

    .result-not_found {
      background: rgba(240, 180, 41, 0.15);
      color: var(--warning);
    }

    .result-error, .result-no_parent, .result-no_media, .result-insufficient_info {
      background: rgba(229, 57, 53, 0.15);
      color: var(--error);
    }

    .mention-content {
      margin-bottom: 16px;
    }

    .mention-text {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      font-style: italic;
    }

    /* Reddit Preview Card */
    .reddit-preview {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 16px;
      border-left: 3px solid var(--accent);
    }

    .reddit-preview-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .reddit-preview-header .subreddit {
      color: var(--accent);
      font-weight: 600;
    }

    .reddit-preview-header .author {
      color: var(--text-secondary);
    }

    .reddit-preview-header .dot {
      color: var(--text-secondary);
      opacity: 0.5;
    }

    .reddit-preview-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.4;
      margin-bottom: 0;
    }

    .no-extract {
      color: var(--text-secondary);
      font-size: 13px;
      font-style: italic;
    }

    /* Footer with link */
    .mention-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .twitter-source {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .twitter-source a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .twitter-source a:hover {
      text-decoration: underline;
    }

    .reddit-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .reddit-link:hover {
      background: var(--accent-dim);
    }

    .reddit-link-subtle {
      color: var(--accent);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
    }

    .reddit-link-subtle:hover {
      text-decoration: underline;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 48px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      .stats-row {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">üîç</div>
        <h1>FindThisThread</h1>
      </div>
      <div class="stats-row" id="stats">
        <div class="stat-badge">Total: <span class="value" id="stat-total">-</span></div>
        <div class="stat-badge">Found: <span class="value" id="stat-success">-</span></div>
        <div class="stat-badge">Not Found: <span class="value" id="stat-failed">-</span></div>
      </div>
    </header>

    <div class="timer-section">
      <div class="timer-header">
        <h2>Next Check</h2>
        <div class="timer-controls">
          <button class="refresh-btn" id="refresh-btn" onclick="triggerRefresh()">
            Refresh Now
          </button>
          <div class="timer-status">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Running</span>
          </div>
        </div>
      </div>
      <div class="timer-bar-container">
        <div class="timer-bar" id="timer-bar" style="width: 100%"></div>
      </div>
      <div class="timer-text">
        <span>Last check: <span id="last-check">-</span></span>
        <span class="timer-countdown" id="countdown">-</span>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>Recent Finds</h2>
        <span class="section-count" id="success-count"></span>
      </div>
      <div class="mentions-grid" id="successes-list">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>All Mentions</h2>
        <span class="section-count" id="mentions-count"></span>
      </div>
      <div class="mentions-grid" id="mentions-list">
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let pollInterval = 30000;
    let nextCheckTime = Date.now() + pollInterval;
    let lastCheckTime = Date.now();

    // Format relative time
    function formatRelativeTime(date) {
      const now = new Date();
      const diff = now - new Date(date);
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);

      if (seconds < 60) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return new Date(date).toLocaleDateString();
    }

    // Format countdown
    function formatCountdown(ms) {
      if (ms <= 0) return 'Checking...';
      const seconds = Math.ceil(ms / 1000);
      return `${seconds}s`;
    }

    // Get result label
    function getResultLabel(result) {
      const labels = {
        'found': 'Found',
        'not_found': 'Not Found',
        'no_parent': 'No Parent',
        'no_media': 'No Image',
        'insufficient_info': 'No Info',
        'error': 'Error'
      };
      return labels[result] || result;
    }

    // Create mention card HTML
    function createMentionCard(mention) {
      const hasExtracted = mention.extracted_subreddit || mention.extracted_username || mention.extracted_title;

      // Build Reddit preview card
      let previewHtml = '';
      if (hasExtracted) {
        const headerParts = [];
        if (mention.extracted_subreddit) {
          headerParts.push(`<span class="subreddit">r/${mention.extracted_subreddit}</span>`);
        }
        if (mention.extracted_username) {
          headerParts.push(`<span class="author">u/${mention.extracted_username}</span>`);
        }

        const headerHtml = headerParts.length > 0
          ? `<div class="reddit-preview-header">${headerParts.join('<span class="dot">‚Ä¢</span>')}</div>`
          : '';

        const titleHtml = mention.extracted_title
          ? `<div class="reddit-preview-title">${mention.extracted_title}</div>`
          : '';

        previewHtml = `
          <div class="reddit-preview">
            ${headerHtml}
            ${titleHtml}
          </div>
        `;
      } else {
        // Show reason if no extraction
        const reasons = {
          'no_parent': 'No parent tweet found',
          'no_media': 'No image in parent tweet',
          'insufficient_info': 'Could not extract Reddit info from image',
          'error': 'An error occurred during processing'
        };
        previewHtml = `<p class="no-extract">${reasons[mention.result] || 'No details available'}</p>`;
      }

      // Footer with source and link
      let footerHtml = '<div class="mention-footer">';

      // Twitter source
      const authorDisplay = mention.author_username && mention.author_username !== 'unknown'
        ? `@${mention.author_username}`
        : '';
      footerHtml += `<span class="twitter-source">${authorDisplay ? `Requested by ${authorDisplay}` : ''} ${formatRelativeTime(mention.processed_at)}</span>`;

      // Reddit link
      if (mention.reddit_url) {
        footerHtml += `<a href="${mention.reddit_url}" target="_blank" class="reddit-link">View on Reddit ‚Üí</a>`;
      }

      footerHtml += '</div>';

      return `
        <div class="mention-card">
          <div class="mention-header">
            <span class="mention-result result-${mention.result}">${getResultLabel(mention.result)}</span>
          </div>
          <div class="mention-content">
            ${previewHtml}
          </div>
          ${footerHtml}
        </div>
      `;
    }

    // Fetch and update status
    async function updateStatus() {
      try {
        const res = await fetch(`${API_BASE}/api/status`);
        const data = await res.json();

        pollInterval = data.pollIntervalMs;
        nextCheckTime = data.nextCheckTime;
        lastCheckTime = data.lastCheckTime;

        document.getElementById('stat-total').textContent = data.stats.total;
        document.getElementById('stat-success').textContent = data.stats.successful;
        document.getElementById('stat-failed').textContent = data.stats.failed;

        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        if (data.isRunning) {
          statusDot.style.background = 'var(--success)';
          statusText.textContent = 'Running';
        } else {
          statusDot.style.background = 'var(--error)';
          statusText.textContent = 'Stopped';
        }
      } catch (e) {
        console.error('Failed to fetch status:', e);
      }
    }

    // Fetch and update mentions
    async function updateMentions() {
      try {
        const [mentionsRes, successesRes] = await Promise.all([
          fetch(`${API_BASE}/api/mentions?limit=20`),
          fetch(`${API_BASE}/api/successes?limit=5`)
        ]);

        const mentionsData = await mentionsRes.json();
        const successesData = await successesRes.json();

        const mentionsList = document.getElementById('mentions-list');
        const successesList = document.getElementById('successes-list');

        if (mentionsData.mentions.length === 0) {
          mentionsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <p>No mentions yet. Tag @findthisthread on a Reddit screenshot!</p>
            </div>
          `;
        } else {
          mentionsList.innerHTML = mentionsData.mentions.map(createMentionCard).join('');
          document.getElementById('mentions-count').textContent = `${mentionsData.mentions.length} shown`;
        }

        if (successesData.successes.length === 0) {
          successesList.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üîç</div>
              <p>No successful finds yet.</p>
            </div>
          `;
        } else {
          successesList.innerHTML = successesData.successes.map(createMentionCard).join('');
          document.getElementById('success-count').textContent = `${successesData.successes.length} recent`;
        }
      } catch (e) {
        console.error('Failed to fetch mentions:', e);
      }
    }

    // Update timer bar
    function updateTimer() {
      const now = Date.now();
      const timeLeft = Math.max(0, nextCheckTime - now);
      const progress = 1 - (timeLeft / pollInterval);

      document.getElementById('timer-bar').style.width = `${Math.min(100, progress * 100)}%`;
      document.getElementById('countdown').textContent = formatCountdown(timeLeft);
      document.getElementById('last-check').textContent = formatRelativeTime(lastCheckTime);

      if (timeLeft <= 0) {
        // Trigger a refresh when timer hits 0
        nextCheckTime = now + pollInterval;
        setTimeout(() => {
          updateStatus();
          updateMentions();
        }, 2000);
      }
    }

    // Trigger manual refresh
    async function triggerRefresh() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.classList.add('loading');

      try {
        const res = await fetch(`${API_BASE}/api/refresh`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          // Wait a moment for the check to complete, then refresh data
          setTimeout(() => {
            updateStatus();
            updateMentions();
          }, 3000);
        }
      } catch (e) {
        console.error('Failed to trigger refresh:', e);
      } finally {
        setTimeout(() => {
          btn.disabled = false;
          btn.classList.remove('loading');
        }, 3000);
      }
    }

    // Initial load
    updateStatus();
    updateMentions();

    // Update timer every second
    setInterval(updateTimer, 1000);

    // Refresh data every 10 seconds
    setInterval(() => {
      updateStatus();
      updateMentions();
    }, 10000);
  </script>
</body>
</html>
